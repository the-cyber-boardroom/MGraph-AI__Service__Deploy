# Deploy Service MVP - Phase 2 Implementation Summary

**version** v0.7.0
## Overview

Phase 2 adds **workflow execution** capabilities to the Deploy Service. Instead of making individual API calls, clients can now submit a workflow that describes multiple secrets operations to execute in sequence.

## New Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/workflows/execute` | Execute a workflow (perform all operations) |
| POST | `/workflows/plan` | Dry-run preview (analyze without executing) |

## Workflow Concept

A workflow is a declarative description of operations to perform on a target repository:

```json
{
  "credentials": {
    "encrypted_pat": "<NaCl-encrypted GitHub PAT>"
  },
  "workflow": {
    "target": {
      "owner": "the-cyber-boardroom",
      "repo": "MGraph-AI__Service__Deploy"
    },
    "operations": [
      {"action": "create", "secret_name": "AWS_ACCESS_KEY_ID", "secret_value": "<encrypted>"},
      {"action": "create", "secret_name": "AWS_SECRET_ACCESS_KEY", "secret_value": "<encrypted>"},
      {"action": "delete", "secret_name": "OLD_SECRET"},
      {"action": "list"}
    ]
  }
}
```

## Supported Actions

| Action | Required Fields | Description |
|--------|-----------------|-------------|
| `create` | `secret_name`, `secret_value` | Create or update a secret |
| `delete` | `secret_name` | Delete a secret |
| `exists` | `secret_name` | Check if secret exists |
| `get` | `secret_name` | Get secret metadata |
| `list` | (none) | List all secrets in repository |

## New Files

### Schemas (`schemas/workflow/`)

| File | Purpose |
|------|---------|
| `Schema__Workflow__Operation.py` | Single operation (action + secret_name + secret_value) |
| `Schema__Workflow.py` | Complete workflow (target + list of operations) |
| `Schema__Workflow__Credentials.py` | Encrypted PAT for authentication |
| `Schema__Request__Workflow__Execute.py` | Execute request |
| `Schema__Request__Workflow__Plan.py` | Plan request |
| `Schema__Response__Workflow__Execute.py` | Execute response with results |
| `Schema__Response__Workflow__Plan.py` | Plan response with preview |
| `Schema__Workflow__Operation_Result.py` | Individual operation result |

### Service (`services/`)

| File | Purpose |
|------|---------|
| `Service__Workflow__Executor.py` | Workflow execution business logic |

### Routes (`fast_api/routes/`)

| File | Purpose |
|------|---------|
| `Routes__Workflows.py` | `/workflows/execute` and `/workflows/plan` endpoints |

## Response Examples

### Execute Response

```json
{
  "success": true,
  "target_owner": "the-cyber-boardroom",
  "target_repo": "MGraph-AI__Service__Deploy",
  "total_operations": 4,
  "operations_succeeded": 4,
  "operations_failed": 0,
  "results": [
    {"index": 0, "action": "create", "secret_name": "AWS_ACCESS_KEY_ID", "success": true},
    {"index": 1, "action": "create", "secret_name": "AWS_SECRET_ACCESS_KEY", "success": true},
    {"index": 2, "action": "delete", "secret_name": "OLD_SECRET", "success": true},
    {"index": 3, "action": "list", "success": true, "data": {"secrets": [...]}}
  ],
  "duration": 1.234,
  "stop_on_error": true
}
```

### Plan Response

```json
{
  "success": true,
  "valid": true,
  "target_owner": "the-cyber-boardroom",
  "target_repo": "MGraph-AI__Service__Deploy",
  "total_operations": 3,
  "operations_by_action": {"create": 2, "delete": 1},
  "planned_operations": [
    {"index": 0, "action": "create", "secret_name": "NEW_SECRET", "will_create": true, "current_exists": false},
    {"index": 1, "action": "create", "secret_name": "EXISTING", "will_update": true, "current_exists": true},
    {"index": 2, "action": "delete", "secret_name": "NONEXISTENT", "is_noop": true, "warnings": ["Secret does not exist"]}
  ],
  "warnings": ["Operation 2: Secret 'NONEXISTENT' does not exist, delete will have no effect"],
  "duration": 0.567
}
```

## Key Features

### Validation
- Workflows are validated before execution
- Each operation type has required field validation
- Empty workflows are rejected

### Planning
- Preview what operations will do before executing
- Detects create vs update (based on existing secrets)
- Warns about no-op operations (e.g., deleting non-existent secrets)

### Execution
- Operations execute in order
- By default, stops on first error (`stop_on_error: true`)
- Each operation result includes success/error status

### Security
- Same pass-through encryption model as Phase 1
- `encrypted_pat` and `secret_value` are encrypted with NaCl SealedBox
- Deploy Service never decrypts credentials

## Test Summary

| Category | File | Tests |
|----------|------|-------|
| Schema Unit | `test_Schema__Workflow__Operation.py` | 16 |
| Schema Unit | `test_Schema__Workflow.py` | 10 |
| Service Unit | `test_Service__Workflow__Executor.py` | 15 |
| Route Unit | `test_Routes__Workflows.py` | 14 |
| Integration | `test_Workflows.py` | 14 |
| **Total** | | **69** |

All tests use the GitHub Surrogate architecture established in Phase 1.

## Usage with QA Client

```python
from QA__Deploy_Service_Client import create_deploy_client

client = create_deploy_client(service_url='http://0.0.0.0:10027')

# Plan first
plan_result = client.http_client.post('/workflows/plan', json={
    'credentials': {'encrypted_pat': client.encrypted_pat()},
    'workflow': {
        'target': {'owner': 'my-org', 'repo': 'my-repo'},
        'operations': [
            {'action': 'create', 'secret_name': 'SECRET_1', 'secret_value': client.encrypt_value('value1')},
            {'action': 'create', 'secret_name': 'SECRET_2', 'secret_value': client.encrypt_value('value2')},
        ]
    }
}).json()

print(f"Plan valid: {plan_result['valid']}")
print(f"Operations: {plan_result['total_operations']}")

# Execute if plan looks good
if plan_result['valid']:
    exec_result = client.http_client.post('/workflows/execute', json=...).json()
    print(f"Success: {exec_result['success']}")
```

## Next Steps (Phase 3 Ideas)

1. **Workflow Templates**: Predefined workflows for common scenarios
2. **Async Execution**: Return job ID, poll for status
3. **Rollback**: Undo operations on failure
4. **Conditional Operations**: Execute based on conditions
5. **Parallel Operations**: Execute independent operations concurrently